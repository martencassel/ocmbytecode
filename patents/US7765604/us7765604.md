# US Patent 7765604 - Digital Rights Management System

## Abstract / Summary


## Patent Examination Documents

### 6. European Patent Office
- **European Search Report**, EP 02250898, dated Nov. 9, 2009
- **Partial European Search Report** (Reference: XP002259291)

> **Patent Process**: Official examination documents from the European Patent Office for the corresponding European patent application.Related Publications


> **Relevance**: Foundational work on hierarchical key management systems, likely influencing the EKB (Enabling Key Block) approach used in this patent.: This patent describes a digital rights management (DRM) system where content distribution and access control are separated.

A client receives encrypted content from content server. The header of the content includes license-identifying information for identifying a license required to utilize the content. The client requests a license server to transmit the license identified by the license-identifying information. When receiving the request for a license, the license server carries out a charging process before transmitting the license to the client. The client stores the license received from the license server. The stored license serves as a condition for encrypting and playing back the content. As a result, content can be distributed with a high degree of freedom and only an authorized user is capable of utilizing the content.

> **Key Innovation**: Separation of content distribution from license validation, enabling flexible content distribution while maintaining strict access control.

## Field of Invention
> **Technical Domain**: Information processing, digital rights management, content protection

In general, the present invention relates to an information processing method, an information processing apparatus, a program storage medium and a program. More particularly, the present invention relates to an information processing method and an information processing apparatus which are used for preventing content from being copied and used illegally without a license from the owner of the copyright in the content, a program for implementing the information processing method and a program storage medium for storing the program.
## Background and Problem Statement
> **Market Problem**: Illegal content sharing through peer-to-peer networks causing revenue loss for content creators

In recent years, users have provided musical data they own to other users and have received musical data they do not own from other users through the Internet in content-exchanging system that allows a plurality of users to exchange musical data free of charge. In Such content-exchanging System, theoretically, music or another content owned by one user can thus be enjoyed by other users. Therefore, many users do not have to purchase Such a piece of music or such content. As a result, since Such a piece of music or Such content does not sell well, the owner of the copyright in the content loses the opportunity to gain a royalty for the use of the piece of music or the content accom panying the sales of the piece of music or the content. In Society, there is thus a demand to prevent content from being copied and used illegally.

> **Objective**: Create a reliable system to prevent unauthorized content usage while maintaining distribution flexibility

## Primary Claims - Information Processing Apparatus
> **Core Innovation**: Client-side apparatus that enforces license requirements for content access

It is thus an object of the present invention addressing the problems described above to reliably prevent content from being used illegally. In accordance with an aspect of the present invention, there is provided an information processing apparatus for allowing usage of content by requiring a license for using the content. The information processing apparatus includes a content Stor age unit operable to store license-identification information for specifying the license for using the content, encrypted data of the content and key information required for decrypt ing the encrypted data of the content; a license storage unit operable to store the license for using the content, including content-specifying information for specifying the content, the use of which is allowed by the license; a judgment unit operable to determine whether the license for using the con tent has been stored in the license storage unit; and a decryp tion unit operable to decrypt the encrypted data of the content if the license for using the content has been stored in the license storage unit.

> **Communication Components**: Network functionality for license acquisition

The information processing apparatus further includes a transmitter operable to transmit a request for the license to a license server, the license request including the license-iden tification information; and a receiver operable to receive the
license transmitted by the license server. The received license may be stored in the license storage unit. The information processing apparatus further includes a reproducing unit operable to reproduce the data of the content decrypted by the decryption unit, wherein the data of the content is text data, image data, audio data, moving-picture data or combinations thereof.

> **Cryptographic Infrastructure**: EKB (Enabling Key Block) system for secure key distribution

The information processing apparatus further includes a device-node-key storage unit operable to store a device node key. The key information includes an EKB (Enabling Key Block). The decryption unit is operable to decrypt the EKB (Enabling Key Block) using the device node key to obtain a root key, and to decrypt the data of the content using the root key.

> **License Features**: Usage conditions and digital signatures for authenticity

In the information processing apparatus, the license further includes usage-condition information showing a condition for using the content, the use of which is allowed by the license.

In the information processing apparatus, the license further includes an electronic signature signed by using a secret key of a license server.

> **Device Binding**: Terminal-specific licenses to prevent license sharing

The information processing apparatus further has a termi nal-ID storage unit operable to store terminal-identification information identifying the information processing appara tus. The license request further includes the terminal identi fication information, and the received license includes a ter minal ID. The judgment unit compares the terminal ID in the received license with the terminal-identification information stored in the terminal-ID storage unit and determines that the received license is the license for using the content only if the terminal ID in the received license matches the terminal identification information stored in the terminal-ID storage unit.

## Method Claims
> **Process Definition**: The same functionality expressed as a method rather than apparatus

In accordance with another aspect of the present invention, there is provided an information processing method for allowing a user to use content by requiring the user to have a license for using the content. The information processing method includes storing license-identification information for specifying the license for using the content, encrypted data of the content and key information required for decrypt ing the encrypted data of the content; storing the license for using the content in a license storage unit, the license includ ing content-specifying information for specifying the con tent, the use of which is allowed by the license; determining whether the license for using the content has been stored in the license storage unit; and decrypting the encrypted data of the content if the license for using the content has been stored in the license storage unit.

## Program and Storage Medium Claims
> **Software Implementation**: Patent coverage for software implementations and storage media

In accordance with a further aspect of the present inven tion, there is provided a recording medium recorded with a program to be executed by a computer for carrying out pro cessing to allow a user to use content by requiring the user to have a license for using the content. The program includes storing license-identification information for specifying the license for using the content, encrypted data of the content and key information required for decrypting the encrypted data of the content; storing the license for using the content in a license storage unit, the license including content-specify ing information for specifying the content, the use of which is allowed by the license; determining whether the license for using the content has been stored in the license storage unit;
and decrypting the encrypted data of the content if the license for using the content has been stored in the license storage unit.

> **Encryption Note**: The software itself may be encrypted for additional protection

The program or a portion of the program may be encrypted.

## License Server Claims
> **Server-Side Infrastructure**: The complementary license server that issues and manages licenses

In accordance with a still further aspect of the present invention, there is provided a license server for issuing a license for allowing the use of content. The license server includes a license storage unit operable to store the license, the license including content-specifying information for specifying the content, the use of which is allowed by the license; and terminal-identification information for identify ing an information processing apparatus; a receiver operable to receive a request for the license from the information processing apparatus, the license request including license identification information for identifying the license; an extraction unit operable to extract the license identified by the license-identification information from the license storage unit; a processor operable to add the terminal-identification information to the extracted license; a signature unit operable to put a signature on the extracted license including the ter minal-identification information using a secret key of the license server; and a transmitter operable to transmit the extracted license with the signature thereon to the informa tion processing apparatus.

## License Server Method Claims
> **Server Process**: Method claims for the license server functionality

In accordance with a still further aspect of the present invention, there is provided a method for issuing a license for allowing the use of content. The method includes storing the license in a license storage unit, the license including content specifying information for specifying the content, the use of which is allowed by the license, and terminal-identification information for identifying an information processing appa ratus; receiving a request for the license from the information processing apparatus, the license request including license identification information for identifying the license; extract ing the license stored in the license storage unit and identified by the license-identification information; adding the termi nal-identification information to the extracted license; putting a signature on the extracted license including the terminal identification information using a secret key; and transmitting the extracted license with the signature thereon to the infor mation processing apparatus.

## Summary of Advantages
> **System Benefits**: Key advantages of the proposed DRM system

In the information processing method, the information pro cessing apparatus and the recording medium recorded with the program which are provided by the present invention, content is decrypted and can be used on condition that the user has a license for using the content.

In the license server and the information processing method provided by the present invention, a valid license is issued only to a specific information processing apparatus.

---

## Technical Analysis

### Key Components:
1. **EKB (Enabling Key Block)** - Hierarchical key distribution system
2. **Device Node Keys** - Device-specific cryptographic keys
3. **License-Content Separation** - Content and licenses distributed independently
4. **Terminal ID Binding** - Licenses tied to specific devices
5. **Digital Signatures** - License authenticity verification

### Security Model:
- Content encrypted with content keys
- Content keys encrypted in EKB structure
- EKB decrypted using device node keys
- Licenses required to authorize decryption
- Terminal binding prevents license sharing



# Other Publications


> **Background Research**: Academic and technical publications that form the foundation for this patent's innovations

## Key Management and Group Communication

### 1. VersaKey Framework
**Waldvogel, M. et al.**, "The VersaKey Framework: Versatile Group Key Management"
*IEEE Journal on Selected Areas in Communications*, Sep. 1999, vol. 17, No. 9, pp. 1614-1631.

Link: https://d-nb.info/1100389962/34

> **System Overvie# Prior Art an### 2. Key Graph Communications
**Wong, C. K. et al.**, "Secure Group Communications Using Key Graphs"
*Proceedings of ACM SIGCOMM'98*, (1998), pp. 68-79

Link: https://citeseerx.ist.psu.edu/document?repid=rep1&type=pdf&doi=d249fd915c0748ed33580043f07becd04b262afa

> **Relevance**: Early research on tree-based key distribution, providing theoretical foundation for scalable key management.

## Digital Content Protection

### 3. Key Management for Content Protection
**Nakano, et al.**, "Key Management System for Digital Content Protection"
*2001 Symposium on Cryptography and Information Security*, Oiso, Japan, Jan. 23-26, 2001
The Institute of Electronics, Information and Communication Engineers, pp. 213-220.

> **Relevance**: Direct predecessor work on applying key management to digital content protection, closely related to this patent's domain.

### 4. DRM Framework Research
**Lee, J. et al.**, "A DRM Framework for Distributing Digital Contents through the Internet"
*ETRI Journal*, vol. 25, No. 6, Dec. 2003, pp. 423-436
URL: http://etrijetrire.kr/Cyber/servlet/GetFile?fileid=SPF 1070442843432

Link: https://citeseerx.ist.psu.edu/document?repid=rep1&type=pdf&doi=9915c17b54296d5f649822498dd26f093b1effa0

> **Relevance**: Contemporary research on internet-based DRM systems, showing the competitive landscape and alternative approaches.

## Cryptographic References

### 5. Applied Cryptography Handbook
**Menezes, A. J. et al.**, "Handbook of Applied Cryptography: Key Management Through Symmetric-Key Techniques"
*CRC Press Series on Discrete Mathematics and Its Applications*, Jan. 1, 1997
CRC Press LLC, USA, pp. 36, 551-553, XP002259291.

pp. 36: 1.11.1 Key management through symmetric-key techniques
pp. 551: Public-key vs. symmetric-key techniques (in key management),
pp. 551: 13.3 Techniques for distributing confidential keys
pp. 551: 13.3.1 Key layering and cryptoperiods
pp. 552: Figure 13.4: Key management: symmetric-key vs. public-key encryption.
pp. 553: Cryptoperiods, long-term keys, and short-term keys

> **Relevance**: Standard cryptographic reference for symmetric key management techniques underlying the security model.

Drawings

FIG. 1 is a schematic diagram showing the configuration of content-exchanging system to which the present invention is applied;

FIG. 2 is a block diagram showing the configuration of a client shown in FIG. 1;

FIG.3 is a flowchart used for explaining processing carried out by the client shown in FIG. 1 to download content;

FIG. 4 is a flowchart used for explaining processing carried out by content server shown in FIG. 1 to provide a client with content;

FIG. 5 is a diagram showing a typical format of data gen erated at step S26 of the flowchart shown in FIG. 4;

FIG. 6 is a flowchart used for explaining processing carried out by the client shown in FIG. 1 to play back content;

FIG. 7 is a flowchart used for explaining details of process ing carried out at step S43 of the flowchart shown in FIG. 6 to acquire a license;

FIG. 8 is a diagram showing the configuration of a license;

FIG.9 is a flowchart used for explaining processing carried out by a license server shown in FIG. 1 to issue a license;

FIG. 10 is a flowchart used for explaining details of pro cessing carried out at step S45 of the flowchart shown in FIG. 6 to update a license;

FIG. 11 is a flowchart used for explaining processing car ried out by the license server shown in FIG. 1 to update a license:

FIG. 12 is an explanatory diagram showing an organization of keys;

FIG. 13 is an explanatory diagram showing category nodes;

FIG. 14 is a diagram concretely showing the typical asso ciation of nodes with devices;

FIGS. 15A and 15B are explanatory diagrams showing the configuration of an EKB (Enabling Key Block);

FIG. 16 is an explanatory diagram showing use of the EKB (Enabling Key Block);

FIG. 17 is an explanatory diagram showing a typical format of the EKB (Enabling Key Block);

FIGS. 18A to 18C are explanatory diagrams showing the configuration of tags in an EKB (Enabling Key Block);

FIG. 19 is an explanatory diagram showing processing to decrypt content by using a DNK (Device Node Key);

FIG. 20 is a diagram showing a typical EKB (Enabling Key Block);

FIG. 21 is an explanatory diagram showing assignment of a plurality of contents to a device;

FIG. 22 is an explanatory diagram showing license catego r1es;

FIG. 23 is a flowchart used for explaining a ripping process carried out by a client;

FIG. 24 is an explanatory diagram showing the configura tion of a watermark;

FIG. 25 is an explanatory diagram showing a typical format of content;

FIG. 26 is a diagram showing a typical certificate of a disclosed key:

FIG. 27 is an explanatory diagram showing distribution of content;

FIG. 28 is a flowchart used for explaining processing car ried out by a client to check out content;

FIG. 29 is an explanatory diagram showing typical tracing of an EKB (Enabling Key Block) by using tags;

FIG. 29 is an explanatory diagram showing typical tracing of an EKB (Enabling Key Block) by using tags;

FIG. 29 is an explanatory diagram showing typical tracing of an EKB (Enabling Key Block) by using tags;

...

FIG. 44 is a flowchart used for explaining processing car ried out by a client to check in a license checked out by another client;

FIG. 45 is a flowchart representing processing carried out by a client issuing a request for the processing to check in a license to another client carrying out the license-check-in processing represented by the flowchart shown in FIG. 44;

FIG. 46 is an explanatory diagram showing generation of a MAC (Message Authentication Code);

FIG. 47 is a flowchart used for explaining processing to decrypt an ICV (Integrity Check Value) generation key:

FIG. 48 is a flowchart used for explaining other processing to decrypt the ICV generation key:

FIGS. 49A and 49B are explanatory diagrams showing ICV-based management of operations to copy a license;

FIG. 50 is an explanatory diagram showing management of licenses.

# Detailed Description

## FIG.1 - System Architecture Overview

> **System Design**: Three-tier DRM architecture separating content distribution, license management, and billing

FIG. 1 is a block diagram showing the configuration of content-exchanging system to which the present invention is applied. Clients 1-1 and 1-2 are connected to the Internet2. In the following description, the clients 1-1 and 1-2 are each denoted by generic reference numeral 1 if it is not necessary to distinguish the clients 1-1 and 1-2 from each other. In this example, only two clients are shown. However, any arbitrary number of clients can be connected to the Internet 2.

In addition, content server 3, a license server 4 and a charging server 5 are also connected to the Internet 2. The content server 3 provides contents to the client 1, and the license server 4 provides the client 1 with a license required for using content provided by the content server 3. The charging server 5 carries out a charging process for the client 1 when the client 1 receives a license from the license server 4.

Any arbitrary number of content servers 3, license servers 4 and charging servers 5 can be connected to the Internet 2.

### System Architecture Diagram

```
                           ╔══════════════════════════╗
                           ║         INTERNET         ║
                           ║           (2)            ║
                           ╚════════════╤═════════════╝
                                        │
        ┌───────────────────────────────┼───────────────────────────────┐
        │                               │                               │
        │                               │                               │
   ┌────▼────┐                     ┌────▼────┐                     ┌────▼────┐
   │         │                     │         │                     │         │
   │CLIENT   │                     │CLIENT   │                     │CLIENT   │
   │  1-1    │                     │  1-2    │                     │ 1-n     │
   │         │                     │         │                     │ (more)  │
   └─────────┘                     └─────────┘                     └─────────┘
        ▲                               ▲                               ▲
        │                               │                               │
        └─────────── Encrypted Content ─┼─────────── License Request ───┘
                    + License Requests  │             + Terminal ID
                                        │
                ┌───────────────────────┼───────────────────────┐
                │                       │                       │
                │                       │                       │
           ┌────▼────┐              ┌────▼────┐              ┌────▼────┐
           │         │              │         │              │         │
           │CONTENT  │              │LICENSE  │              │CHARGING │
           │SERVER   │              │SERVER   │◄─────────────┤SERVER   │
           │   (3)   │              │   (4)   │              │   (5)   │
           │         │              │         │              │         │
           └─────────┘              └─────────┘              └─────────┘
                │                       │                       │
                │                       │                       │
           Stores & Distributes    Issues Licenses         Processes Payments
           Encrypted Content       + Terminal Binding      Before License Issue
           + License IDs          + Digital Signatures     + Usage Tracking
```

### Key System Components:

#### **Clients (1-1, 1-2, ... 1-n)**
- **Function**: End-user devices that consume protected content
- **Capabilities**:
  - Download encrypted content from Content Server
  - Request licenses from License Server
  - Store and validate licenses locally
  - Decrypt content only when valid license present
- **Security**: Each client has unique Terminal ID for license binding

#### **Content Server (3)**
- **Function**: Distributes encrypted digital content
- **Content**: Audio, video, text, images, or multimedia combinations
- **Security**: Content encrypted with content keys embedded in EKB structure
- **Metadata**: Includes license-identifying information in content headers

#### **License Server (4)**
- **Function**: Issues and manages usage licenses
- **Security Features**:
  - Terminal ID binding (prevents license sharing)
  - Digital signatures for authenticity
  - Usage condition enforcement
- **Coordination**: Communicates with Charging Server before license issuance

#### **Charging Server (5)**
- **Function**: Handles billing and payment processing
- **Process**: Validates payment before authorizing License Server to issue license
- **Integration**: Part of the three-tier security model ensuring monetization

### **Key Innovation - Separation of Concerns:**

1. **Content Distribution** ↔ **License Management** are **decoupled**
2. **Flexible Content Distribution**: Content can be freely distributed (even through P2P)
3. **Strict Access Control**: Usage requires separate license acquisition and payment
4. **Scalable Architecture**: Multiple servers of each type can be deployed

This architecture enables **secure content distribution at scale** while maintaining **strong DRM protection** and **flexible business models**.

## FIG.2 - Client Hardware Architecture

> **Client Design**: Detailed hardware architecture of DRM-capable client device with specialized cryptographic and codec components

FIG. 2 is a block diagram showing the configuration of the client 1. In the client 1 shown in FIG. 2, a CPU (Central Processing Unit) 21 carries out various kinds of processing in accordance with programs stored in a ROM (Read-Only Memory) 22 and programs loaded from a storage unit 28 into a RAM (Random-Access Memory) 23. A timer 20 measures the lapse of time and Supplies a result of measurement to the CPU21. The RAM 23 is also used for storing data required by the CPU21 in the execution of the various kinds of processing. An encryption and decryption unit 24 encrypts content and decrypts already encrypted content. A codec unit 25 encodes content in accordance with an ATRAC (Adaptive Transform Acoustic Coding)-3 system and Supplies the encoded content to a semiconductor memory 44 to be stored therein. The semiconductor memory 44 is connected to a drive 30. An example of the semiconductor memory 44 is a Memory Stick (a trademark). In addition, the codec unit 25 decodes encoded data read out from the semiconductor memory 44 through the drive 30.

The CPU21, the ROM 22, the RAM 23, the encryption and decryption unit 24, and the codec unit 25 are connected to each other by a bus 31. The bus 31 is also connected to an input/output interface 32. The input/output interface 32 is connected to an input unit 26, an output unit 27, the storage unit 28 and a communication unit 29. The input unit 26 includes a keyboard and a mouse. The output unit 27 includes a speaker and a display unit Such as a CRT or an LCD. The communication unit 29 includes a modem and a terminal adaptor. The communication unit 29 carries out communications through the Internet 2. To be more specific, the communication unit 29 exchanges analog and digital signals with other clients. If necessary, the input/output interface 32 is also connected to the drive 30, on which a proper storage medium such as a magnetic disk 41, an optical disk 42, a magneto-optical disk 43 or the semiconductor memory 44 is mounted. If necessary, a computer program can thus be read out from the storage medium and installed in the storage unit 28.

### Client Hardware Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              CLIENT DEVICE (1)                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐   │
│  │ TIMER   │    │   CPU   │    │   ROM   │    │   RAM   │    │ENCRYPT/ │   │
│  │   (20)  │    │   (21)  │    │   (22)  │    │   (23)  │    │DECRYPT  │   │
│  │         │    │         │    │         │    │         │    │   (24)  │   │
│  └────┬────┘    └────┬────┘    └────┬────┘    └────┬────┘    └────┬────┘   │
│       │              │              │              │              │        │
│       └──────────────┼──────────────┼──────────────┼──────────────┼──────┐ │
│                      │              │              │              │      │ │
│  ┌─────────┐         │              │              │              │      │ │
│  │  CODEC  │         │              │              │              │      │ │
│  │   (25)  │         │              │              │              │      │ │
│  │ ATRAC-3 │         │              │              │              │      │ │
│  └────┬────┘         │              │              │              │      │ │
│       │              │              │              │              │      │ │
│       └──────────────┼──────────────┼──────────────┼──────────────┼──────┤ │
│                      │              │              │              │      │ │
│                   ┌──▼──────────────▼──────────────▼──────────────▼──────▼┐│
│                   │                    SYSTEM BUS (31)                    ││
│                   └──┬─────────────────────────────────────────────────────┘│
│                      │                                                      │
│                   ┌──▼────────────────────────────────────────────────────┐ │
│                   │              I/O INTERFACE (32)                      │ │
│                   └──┬────────┬────────┬────────┬────────┬────────────────┘ │
│                      │        │        │        │        │                  │
│       ┌──────────────▼──┐  ┌──▼──┐  ┌──▼──┐  ┌──▼──┐  ┌──▼──┐              │
│       │    INPUT (26)   │  │OUT  │  │STOR │  │COMM │  │DRIVE│              │
│       │                 │  │(27) │  │(28) │  │(29) │  │(30) │              │
│       │ ┌─────────────┐ │  │     │  │     │  │     │  │     │              │
│       │ │ Keyboard    │ │  │Spkr │  │Hard │  │Modem│  │     │              │
│       │ │ Mouse       │ │  │CRT  │  │Disk │  │Term │  │     │              │
│       │ └─────────────┘ │  │LCD  │  │     │  │Adpt │  │     │              │
│       └─────────────────┘  └─────┘  └─────┘  └─────┘  └──┬──┘              │
│                                                          │                 │
│                               ┌──────────────────────────▼───────┐         │
│                               │         REMOVABLE STORAGE        │         │
│                               │                                  │         │
│                               │ ┌──────────┐ ┌──────────────────┐│         │
│                               │ │Magnetic  │ │  Semiconductor   ││         │
│                               │ │Disk (41) │ │  Memory (44)     ││         │
│                               │ └──────────┘ │  "Memory Stick"  ││         │
│                               │              └──────────────────┘│         │
│                               │ ┌──────────┐ ┌──────────────────┐│         │
│                               │ │Optical   │ │  Magneto-Optical ││         │
│                               │ │Disk (42) │ │  Disk (43)       ││         │
│                               │ └──────────┘ └──────────────────┘│         │
│                               └────────────────────────────────────┘         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
                                   ┌───▼────┐
                                   │INTERNET│
                                   │   (2)  │
                                   └────────┘
```

### Key Hardware Components:

#### **Core Processing Units**
- **CPU (21)**: Central processing unit - executes DRM software, license validation, content processing
- **ROM (22)**: Read-only memory - stores fundamental system programs and DRM bootstrap code
- **RAM (23)**: Random access memory - working memory for DRM operations and content processing
- **Timer (20)**: Precise timing for license expiration, usage tracking, and time-based restrictions

#### **Security-Critical Components**

##### **Encryption/Decryption Unit (24)**
- **Function**: Hardware-based cryptographic processing
- **Operations**:
  - Decrypt EKB (Enabling Key Block) using Device Node Keys
  - Decrypt content using extracted content keys
  - Encrypt content for secure storage
- **Security**: Dedicated hardware prevents software-based attacks on keys

##### **Codec Unit (25)**
- **Function**: Audio/video encoding and decoding
- **Standard**: ATRAC-3 (Adaptive Transform Acoustic Coding)
- **Integration**: Works with encryption unit for secure content pipeline
- **Storage Interface**: Direct connection to removable storage for portable content

#### **Input/Output Systems**

##### **Input Unit (26)**
- **Components**: Keyboard, mouse
- **Function**: User interaction, content selection, license requests

##### **Output Unit (27)**
- **Components**: Speaker, display (CRT/LCD)
- **Function**: Content playback (audio/video)
- **Security**: Output protected by DRM to prevent unauthorized recording

##### **Communication Unit (29)**
- **Components**: Modem, terminal adapter
- **Function**: Internet connectivity for license acquisition
- **Protocols**: Handles both analog and digital communication

##### **Storage Systems**
- **Storage Unit (28)**: Internal hard disk for encrypted content and licenses
- **Drive (30)**: Interface for removable media
- **Removable Media**: Multiple format support for content distribution

#### **System Architecture Features**

##### **Bus Architecture (31)**
- **Design**: Central system bus connecting all core components
- **Security**: Encrypted data paths between security-critical components
- **Performance**: High-speed data transfer for real-time content processing

##### **I/O Interface (32)**
- **Function**: Centralized interface management
- **Security**: Controlled access to prevent DRM bypass
- **Flexibility**: Support for multiple peripheral types

### **Security Design Principles:**

1. **Hardware-based Cryptography**: Dedicated encryption unit prevents software attacks
2. **Secure Boot**: ROM-based system initialization ensures DRM integrity
3. **Isolated Processing**: Separate units for encoding, encryption, and communication
4. **Controlled I/O**: All data flow managed through central interface with security controls
5. **Removable Media Support**: Flexible content distribution while maintaining protection

### **Content Processing Pipeline:**
```
Internet → Communication Unit → I/O Interface → RAM → Encryption Unit → Storage
         ↑                                              ↓
    License Requests                               Codec Unit → Output Unit
```

This architecture ensures that **all content remains encrypted** throughout the system until the moment of authorized playback, with **hardware-based security** preventing circumvention of the DRM protections.

---


## Server Architecture and Configuration

### Unified Server Hardware Design

The **content server 3**, **license server 4**, and **charging server 5** each utilize a configuration **identical to the client hardware** shown in FIG. 2. This design choice provides several advantages:

- **Standardized components** reduce development and maintenance costs
- **Common security features** ensure consistent protection across all system nodes
- **Identical encryption/decryption capabilities** enable end-to-end content protection

```
Server Architecture (All Servers):
┌─────────────────────────────────────────┐
│            Server Hardware              │
│                                         │
│  ┌─────────┐  ┌─────────────────────┐   │
│  │ Timer   │  │       CPU 21        │   │
│  │   20    │  │   (Control Logic)   │   │
│  └─────────┘  └─────────────────────┘   │
│                                         │
│  ┌─────────────────┐  ┌───────────────┐ │
│  │   ROM 22        │  │    RAM 23     │ │
│  │ (System Code)   │  │ (Work Memory) │ │
│  └─────────────────┘  └───────────────┘ │
│                                         │
│  ┌───────────────────┐  ┌─────────────┐ │
│  │ Encryption Unit   │  │ Codec Unit  │ │
│  │      24           │  │     25      │ │
│  │ (Content Security)│  │ (ATRAC3)    │ │
│  └───────────────────┘  └─────────────┘ │
│                                         │
│  ┌────────────────┐  ┌────────────────┐ │
│  │  Storage 28    │  │  Comm Unit 29  │ │
│  │ (Content/Keys) │  │  (Network I/O) │ │
│  └────────────────┘  └────────────────┘ │
└─────────────────────────────────────────┘
```

**Key Design Principle**: By using identical hardware architectures, the system ensures that all nodes can perform the same cryptographic operations and maintain consistent security protocols.

---

## Content Distribution Process (FIG. 3)

The following flowchart explains the **client-initiated content acquisition** process:
```
Client Content Request Flow (FIG. 3):

Step S1: User Access Request
┌─────────────┐     Access Command     ┌──────────────┐
│   Client 1  │ ────────────────────► │Content Server│
│             │                       │      3       │
│ Input Unit  │                       │              │
│    26       │                       │              │
└─────────────┘                       └──────────────┘

Step S2: Content Specification
┌─────────────┐   Content Selection    ┌──────────────┐
│   Client 1  │ ────────────────────► │Content Server│
│             │                       │      3       │
│ User selects│                       │              │
│ desired     │                       │              │
│ content     │                       │              │
└─────────────┘                       └──────────────┘

Step S3: Content Reception
┌─────────────┐   Encrypted Content    ┌──────────────┐
│   Client 1  │ ◄──────────────────── │Content Server│
│             │                       │      3       │
│ Comm Unit   │                       │              │
│    29       │                       │              │
└─────────────┘                       └──────────────┘

Step S4: Content Storage
┌─────────────┐
│   Client 1  │
│             │
│ Storage     │ ← Encrypted content stored
│ Unit 28     │   to hard disk
│             │
└─────────────┘
```

**Process Flow Summary**:
1. **S1**: User operates input unit 26 → CPU 21 controls communication unit 29 → Access content server 3 via Internet 2
2. **S2**: User specifies desired content → CPU 21 accepts specification → Communication unit 29 informs content server 3
3. **S3**: Content server 3 transmits encoded data (see FIG. 4 process) → CPU 21 receives content via communication unit 29
4. **S4**: Encoded content data stored in hard disk of storage unit 28

**Security Note**: Content remains **encrypted during transmission and storage** - no plaintext content exists outside the secure hardware boundary.

---

## Content Server Processing (FIG. 4)

The content server's response to client requests follows this detailed process:
```
Content Server Processing Flow (FIG. 4):

Step S21: Wait for Access
┌──────────────┐       Listening       ┌─────────────┐
│Content Server│ ◄─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│  Internet 2 │
│      3       │                       │             │
│ CPU 21 waits │                       │             │
│for client    │                       │             │
│access        │                       │             │
└──────────────┘                       └─────────────┘

Step S22: Acquire Content Info
┌──────────────┐   Content Request     ┌─────────────┐
│Content Server│ ◄─────────────────────│   Client 1  │
│      3       │                       │             │
│Acquire info  │                       │Transmitted  │
│specifying    │                       │at Step S2   │
│requested     │                       │             │
│content       │                       │             │
└──────────────┘                       └─────────────┘

Step S23: Read Content from Storage
┌──────────────┐                       ┌─────────────┐
│Content Server│                       │Storage Unit │
│      3       │ ────Read Content────► │     28      │
│              │                       │             │
│CPU 21 reads  │                       │Stored       │
│specified     │                       │contents     │
│content       │                       │             │
└──────────────┘                       └─────────────┘

Step S24: Content Encryption
┌──────────────┐     Content Key Kc    ┌─────────────┐
│Content Server│ ────────────────────► │Encryption & │
│      3       │                       │Decryption   │
│              │                       │Unit 24      │
│CPU 21        │ ◄─ Encrypted Content ─│             │
│supplies      │                       │             │
│content       │                       │             │
└──────────────┘                       └─────────────┘

Step S25: Add Header Information
┌──────────────┐
│Content Server│  Header Creation:
│      3       │  ┌─────────────────────┐
│              │  │ • EKB (Key Block)   │
│CPU 21 adds:  │  │ • Key K (Kc)        │
│              │  │ • License ID        │
│              │  └─────────────────────┘
└──────────────┘

Step S26: Transmit Formatted Data
┌──────────────┐  Formatted Content   ┌─────────────┐
│Content Server│ ───────────────────► │   Client 1  │
│      3       │                      │             │
│              │  via Internet 2      │Comm Unit 29 │
│CPU 21        │                      │             │
│transmits     │                      │             │
└──────────────┘                      └─────────────┘
```

**Content Server Operations**:
- **S21**: Passive listening for client connections via communication unit 29
- **S22**: Accept and parse content specification from client (from S2 of FIG. 3)
- **S23**: Retrieve requested content from storage unit 28 (pre-encoded with ATRAC3)
- **S24**: Apply encryption using content key Kc via encryption/decryption unit 24
- **S25**: Package content with security headers (EKB, encrypted key K(Kc), license ID)
- **S26**: Transmit complete formatted data package to requesting client

**Security Implementation**:
- Content stored in storage unit 28 is **already ATRAC3-encoded**
- **Additional encryption** applied using content key Kc before transmission
- **Alternative**: Content can be **pre-encrypted** in storage, eliminating step S24

---

## Content Format Structure (FIG. 5)

The content received by clients follows this standardized format:

```
Content Format Structure (FIG. 5):

┌─────────────────────────────────────────────────────────┐
│                        HEADER                           │
├─────────────────────────────────────────────────────────┤
│  Content Information:                                   │
│  ┌─ Content ID (CID) - Unique content identifier        │
│  └─ Codec System Info - ATRAC3 encoding details        │
├─────────────────────────────────────────────────────────┤
│  DRM Information:                                       │
│  ┌─ Usage Rules - Playback/copy restrictions            │
│  ├─ Status - Current usage counters                     │
│  └─ URL - License server address for license acquisition│
├─────────────────────────────────────────────────────────┤
│  License ID - Identifies required license               │
├─────────────────────────────────────────────────────────┤
│  EKB (Enabling Key Block) - Hierarchical key structure │
├─────────────────────────────────────────────────────────┤
│  Key K(Kc) - Content key Kc encrypted by key K         │
│             (K generated from EKB)                      │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                     DATA PORTION                        │
├─────────────────────────────────────────────────────────┤
│  Encrypted Block 1:                                     │
│  ┌─ Initial Vector IV₁                                  │
│  ├─ Seed₁ (random value)                               │
│  └─ Encrypted Data: E(K'c₁, data₁)                     │
├─────────────────────────────────────────────────────────┤
│  Encrypted Block 2:                                     │
│  ┌─ Initial Vector IV₂                                  │
│  ├─ Seed₂ (random value)                               │
│  └─ Encrypted Data: E(K'c₂, data₂)                     │
├─────────────────────────────────────────────────────────┤
│                    ... (more blocks)                    │
├─────────────────────────────────────────────────────────┤
│  Encrypted Block N:                                     │
│  ┌─ Initial Vector IVₙ                                  │
│  ├─ Seed₍ₙ₎ (random value)                              │
│  └─ Encrypted Data: E(K'cₙ, dataₙ)                     │
└─────────────────────────────────────────────────────────┘
```

### Key Derivation and Encryption Process

**Content Key Derivation**:
```
K'c = Hash(Kc, Seed)
```
Where:
- **Kc**: Base content key (obtained from decrypting K(Kc) using key K from EKB)
- **Seed**: Random value unique to each encrypted block
- **K'c**: Derived key for encrypting specific block
- **Hash**: One-way hash function ensuring key diversity

### Cipher Block Chaining (CBC) Mode

**Encryption Process**:
1. **First 8 bytes**: Encrypted using Initial Vector IV as starting value
2. **Subsequent 8-byte blocks**: Encrypted using result of previous block encryption
3. **Block independence**: Each encrypted block requires previous block result for decryption

**Security Benefits**:
- **Avalanche effect**: Changing one bit affects all subsequent blocks
- **Block isolation**: Decrypting one block doesn't automatically reveal others
- **Random initialization**: IV ensures identical plaintexts produce different ciphertexts

### Content Information Details

**Content ID (CID)**:
- Unique identifier for content in data portion
- Used for cataloging and reference within DRM system

**DRM Information Components**:
- **Usage Rules**: Number of allowed playbacks, copy operations
- **Status**: Current usage counters and limitations
- **URL**: Address of license server 4 for acquiring necessary licenses

**License ID**:
- Identifies specific license required to decrypt and use content
- Links content to authorization and payment systems

**Business Model**: Content can be **distributed freely** but requires **licensed access** for actual usage, enabling wide distribution with controlled monetization.

---

## Content Playback Process (FIG. 6)

The client-side content playback process implements comprehensive license validation: ```
Content Playback Flow (FIG. 6):

Step S41: Content Selection & License ID Extraction
┌─────────────┐                         ┌─────────────┐
│   Client 1  │   User specifies        │ Storage 28  │
│             │   desired content       │             │
│Input Unit 26│ ─────────────────────► │Content with │
│             │                         │License ID   │
│CPU 21       │ ◄────License ID────────│in header    │
└─────────────┘                         └─────────────┘

Step S42: License Availability Check
┌─────────────┐                         ┌─────────────┐
│   Client 1  │                         │ Storage 28  │
│             │   Check if license      │             │
│CPU 21 forms │   exists locally        │Local license│
│judgment:    │ ────────────────────► │repository   │
│License      │                         │             │
│available?   │                         │             │
└─────────────┘                         └─────────────┘
       │
       ├─ No License ──► Step S43: Acquire License (FIG. 7)
       │
       └─ License Found ──► Step S44

Step S44: License Validity Check
┌─────────────┐                         ┌─────────────┐
│   Client 1  │   Compare validity      │   Timer 20  │
│             │   period with current   │             │
│CPU 21 checks│   date/time            │Current      │
│if license   │ ◄─────────────────────│Date/Time    │
│still valid  │                         │             │
└─────────────┘                         └─────────────┘
       │
       ├─ Expired ──► Step S45: Update License (FIG. 10)
       │
       └─ Valid ──► Step S46

Step S46: Load Encrypted Content
┌─────────────┐                         ┌─────────────┐
│   Client 1  │   Read encrypted        │ Storage 28  │
│             │   content               │             │
│CPU 21       │ ────────────────────► │Hard disk    │
│             │                         │             │
│             │ ◄──Encrypted Content──│             │
└─────────────┘                         └─────────────┘
              │
              ▼
┌─────────────┐
│   RAM 23    │ ← Store content for processing
│             │
└─────────────┘

Step S47: Content Decryption
┌─────────────┐   Encrypted blocks     ┌─────────────┐
│   Client 1  │ ───────────────────► │Encryption & │
│             │                       │Decryption   │
│CPU 21       │                       │Unit 24      │
│supplies     │                       │             │
│data         │ ◄──Decrypted Content──│Using Kc     │
└─────────────┘                       └─────────────┘

Step S48: Content Decoding & Output
┌─────────────┐   Decrypted data      ┌─────────────┐
│   Client 1  │ ───────────────────► │ Codec Unit  │
│             │                       │     25      │
│CPU 21       │                       │(ATRAC3      │
│             │ ◄────Decoded Data────│ Decoder)    │
└─────────────┘                       └─────────────┘
              │
              ▼
┌─────────────┐   Audio data          ┌─────────────┐
│ Input/Output│ ───────────────────► │ Output Unit │
│Interface 32 │                       │     27      │
│             │                       │             │
│             │                       │D/A Conv &   │
│             │                       │Speaker      │
└─────────────┘                       └─────────────┘
```

### License Management Process

**Step S41 - Content Identification**:
- User selects content via input unit 26
- CPU 21 acquires Content ID (CID) - title, number, etc.
- System reads License ID from content header (see FIG. 5)

**Step S42 - License Verification**:
- CPU 21 checks storage unit 28 for required license
- If license missing → Proceed to **license acquisition** (FIG. 7)
- If license found → Continue to validity check

**Step S44 - Validity Assessment**:
- Compare license validity period with current time from timer 20
- If expired → Proceed to **license update** (FIG. 10)
- If valid → Continue to content processing

### Content Processing Pipeline

**Step S46 - Content Loading**:
- Read encrypted content from storage unit 28 hard disk
- Load into RAM 23 for processing

**Step S47 - Decryption Process**:
- Supply encrypted content blocks to encryption/decryption unit 24
- Decrypt using content key Kc (obtained via EKB processing - see FIG. 15)
- Process in encrypted-block units as defined in FIG. 5 data portion

**Step S48 - Decoding and Playback**:
- Supply decrypted content to codec unit 25 for ATRAC3 decoding
- Route decoded data through input/output interface 32
- Perform D/A conversion and output to speaker via output unit 27

**Security Enforcement**: Content cannot be played back without valid, current license - system enforces **both presence and validity** of authorization.

---

## License Acquisition Process (FIG. 7)

The detailed license acquisition process requires multiple authentication steps:

```
License Structure (FIG. 8):

┌─────────────────────────────────────────────────────────┐
│                    LICENSE FORMAT                       │
├─────────────────────────────────────────────────────────┤
│  Usage Conditions:                                      │
│  ┌─ Download deadline - Time limit for acquisition      │
│  ├─ Copy limit - Maximum number of copies allowed       │
│  ├─ Checkout count - Current/maximum checkout numbers   │
│  ├─ CD-R recording right - Permission to burn CDs       │
│  ├─ Portable device copies - PD transfer allowances     │
│  ├─ Ownership upgrade right - Purchase vs. rental       │
│  └─ Usage logging duty - Required activity tracking     │
├─────────────────────────────────────────────────────────┤
│  Leaf ID - Links license to specific client device     │
└─────────────────────────────────────────────────────────┘
```

**Usage Conditions Detail**:
- **Download Deadline**: Time-based content access window
- **Copy Operations**: Controlled replication permissions
- **Checkout System**: Temporary device transfers (like library loans)
- **CD-R Rights**: Physical media recording permissions
- **Portable Device (PD) Copies**: Mobile device synchronization
- **License Ownership**: Rental vs. purchase status conversion
- **Usage Logging**: Audit trail requirements for compliance

---

## License Server Processing (FIG. 9)

The license server implements comprehensive validation before issuing licenses:

### License Acquisition Flow (FIG. 7)

```
Step S61: Extract License Server URL
┌─────────────┐                    ┌─────────────┐
│   Client 1  │   Read URL from    │Content Header│
│             │   content header   │(FIG. 5)     │
│CPU 21       │ ──────────────────►│             │
│extracts URL │                    │URL field    │
│for license  │                    │points to    │
│server       │                    │license      │
└─────────────┘                    │server 4     │
                                   └─────────────┘

Step S62: Access License Server
┌─────────────┐     Access URL     ┌─────────────┐
│   Client 1  │ ──────────────────►│License      │
│             │                    │Server 4     │
│Comm Unit 29 │                    │             │
│accesses     │                    │Requests:    │
│via Internet │                    │• User ID    │
│             │                    │• Password   │
│             │                    │• License ID │
└─────────────┘                    └─────────────┘

Step S63-S64: User Credential Entry
┌─────────────┐                    ┌─────────────┐
│   Client 1  │   Display request  │ Output Unit │
│             │ ──────────────────►│     27      │
│CPU 21       │                    │             │
│displays     │                    │User sees    │
│server       │                    │credential   │
│request      │                    │request      │
└─────────────┘                    └─────────────┘
              │
              ▼
┌─────────────┐   User enters:     ┌─────────────┐
│ Input Unit  │   • User ID        │   Client 1  │
│     26      │   • Password       │             │
│             │   • License info   │CPU 21       │
│User         │ ──────────────────►│receives     │
│operates     │                    │credentials  │
│input        │                    │             │
└─────────────┘                    └─────────────┘

Step S65: Transmit License Request
┌─────────────┐   License Request  ┌─────────────┐
│   Client 1  │ ──────────────────►│License      │
│             │                    │Server 4     │
│CPU 21       │   Contains:        │             │
│controls     │   • User ID        │Receives     │
│Comm Unit 29 │   • Password       │request at   │
│to transmit: │   • License info   │Step S102    │
│             │   • Leaf ID        │(FIG. 9)     │
└─────────────┘                    └─────────────┘

Step S66: License Reception Check
┌─────────────┐                    ┌─────────────┐
│   Client 1  │ ◄─ License/Error ──│License      │
│             │                    │Server 4     │
│CPU 21 forms │                    │             │
│judgment:    │   (Server response │Transmits    │
│License      │    at Step S109    │license at   │
│received?    │    or error at     │Step S109 or │
│             │    Step S112)      │error S112)  │
└─────────────┘                    └─────────────┘
       │
       ├─ License Received ──► Step S67: Store License
       │                      ┌─────────────┐
       │                      │ Storage 28  │
       │                      │             │
       │                      │License      │
       │                      │repository   │
       │                      └─────────────┘
       │
       └─ License NOT Received ──► Step S68: Error Processing
                                 ┌─────────────┐
                                 │   Client 1  │
                                 │             │
                                 │CPU 21       │
                                 │inhibits     │
                                 │content      │
                                 │playback     │
                                 └─────────────┘
```

### Authentication and Validation Process

**Step S61 - URL Extraction**:
- CPU 21 reads license server URL from content header (see FIG. 5 DRM information)
- URL points to **license server 4** for this specific content

**Step S62 - Server Connection**:
- Communication unit 29 connects to license server via Internet 2
- License server 4 responds with credential request (Step S102 of FIG. 9)

**Step S63-S64 - User Authentication**:
- License server request displayed on output unit 27
- User enters previously obtained credentials via input unit 26
- **Note**: User ID and password obtained through prior registration with license server 4

**Step S65 - Request Transmission**:
- CPU 21 packages complete license request including:
  - **User ID** and **Password** for authentication
  - **License-specifying information** from content
  - **Leaf ID** from pre-obtained service data

**Step S66-S68 - Response Processing**:
- **Success Path**: License received → Store in storage unit 28 (Step S67)
- **Failure Path**: No license received → Inhibit content playback (Step S68)

**Key Security Feature**: License acquisition can be performed **proactively** before content download, enabling offline content usage once properly licensed.

---

## License Format Structure (FIG. 8)

Licenses supplied to clients contain comprehensive usage control information:
By referring to the flowchart shown in FIG.9, the following description explains processing carried out by the license server 4 to transmit a license to the client 1 in response to the processing carried out by the client 1 to acquire the license as represented by the flowchart shown in FIG. 7. It should be noted that, also in this case, since the license server 4 has a configuration comprising components identical with those employed in the client 1, the same reference numerals as those shown in FIG. 2 are used for denoting identical com ponents in the following description.
As shown in the figure, the flowchart begins with a step S101 at which the CPU 21 employed in the license server 4 waits for the license server 4 to be accessed by the client 1. As the client 1 accesses the license server 4, the flow of the processing goes on to a step S102 at which the license server 4 requests the client 1 to transmit license-specifying informa tion (a license ID), a user ID and a password. Then, the CPU 21 employed in the license server 4 receives the userID, the password, the leaf ID and the license ID from the client 1 through the communication unit 29 at the step S65 of the flowchart shown in FIG. 7, and carries out processing to accept them.

Then, at the next step S103, the CPU 21 employed in the license server 4 accesses the charging server 5 through the communication unit 29 in order to make a request for pro cessing to examine the user identified by the user ID and the password. When receiving the request for Such an examina tion from the license server 4 through the Internet 2, the charging server 5 checks the past payment history of the user identified by the user ID and the password in order to deter mine whether there is a record indicating that the user did not pay for requested licenses in the past. If there is no record indicating that the user did not pay for requested licenses in the past, the charging server 5 transmits an examination result indicating that the granting of a license is approved. If, on the other hand, there is a record indicating that the user did not pay for requested licenses in the past or another bad record, the charging server 5 transmits an examination result indicat ing that the granting of a license is not approved.

Subsequently, at the next step S104, the CPU 21 employed in the license server 4 forms a judgment as to whether the examination result received from the charging server 5 indi cates that the granting of a license is approved or disapproved. If the granting of a license is approved, the flow of the pro cessing goes on to a step S105 at which the CPU21 selects the license specified by the license-specifying information received in the processing carried out at the step S102 from among licenses stored in the storage unit 28, and reads out the selected license from the storage unit 28. Each license stored in the storage unit 28 includes information including the license ID, a version, a creation date and time and a term of validity. Then, at the next step S106, the CPU 21 adds the received leaf ID to the license. Furthermore, at the next step S107, the CPU 21 selects a usage condition associated with the license selected at the step S105. If a usage condition was found at the step S102 to have been specified by the user, if necessary, the usage condition specified by the user is added to a usage condition prepared in advance. The CPU21 then adds the selected usage condition to the license.
Then, at the next step S108, the CPU 21 puts a digital signature on the license by using a secret key of the license server 4 to produce a license with a configuration like the one shown in FIG. 8. Subsequently, at the next step S109, the CPU 21 employed in the license server 4 transmits the license with a configura tion like the one shown in FIG. 8 from the communication unit 29 to the client 1 by way of the Internet 2.

Then, at the next step S110, the CPU 21 employed in the license server 4 stores the license transmitted in the process ing carried out at the step S109 in the storage unit 28 by associating the license with the user ID and the password, which were acquired in the processing carried out at the step S102. As described above, the license includes a usage con dition and a leaf ID. Subsequently, at the next step S111, the CPU21 carries out a charging process. More particularly, the CPU 21 requests the charging server 5 through the commu nication unit 29 to carry out a charging process for the user identified by the user ID and the password. The charging server 5 carries out the charging process based on the request. The processing carried out by the license server 4 is then finished.
If the user does not pay the amount of money determined by the charging process, the user will not be granted a license in the future, even if the granting of a license is requested as described above. That is to say, in the case of such a user, the charging server 5 will not approve the granting of a license as a result of examining whether to grant a license to the user. In other words, the flow of the processing will go from the step S104 to a step S112 at which the CPU 21 employed in the license server 4 carries out an error-handling process. More specifically, the CPU 21 controls the communication unit 29 to output a message informing the client 1 accessing the license server 4 that a license cannot be granted. The process ing carried out by the license server 4 is then finished.
In this case, the client 1 cannot use the content or is not capable of decrypting the encrypted data of the content because the client 1 has failed to obtain a license as described above. FIG. 10 is a flowchart used for explaining details of the processing carried out at the step S45 of the flowchart shown in FIG. 6 to update a license. The processing carried out at steps S131 to S135 is basically the same as the processing carried out at the respective steps S61 to S65 of the flowchart shown in FIG. 7. At the step S133, however, the CPU 21 acquires the license ID of a license to be updated instead of the license ID of a purchased license. Then, at the step S135, the CPU21 transmits a user ID and a password along with the license ID of the license to be updated to the license server 4
In response to what is transmitted in the processing carried out at the step S135, the license server 4 presents usage conditions at a step S153 of a flowchart shown in FIG. 11, as will be described later. Then, at the next step S136, the CPU 21 employed in the client 1 receives the presented usage conditions from the license server 4 and displays them on the output unit 27. The user operates the input unit 26 to select one of the displayed usage conditions and/or newly add a predetermined usage condition. Subsequently, at the next step S137, the CPU 21 transmits an application to purchase a usage condition selected as described above or a condition to update a license to the license server 4. In response to the application, the license server 4 transmits an eventual usage condition at a step S154 of the flowchart shown in FIG. 11, as will be described later. Then, at the next step S138, the CPU 21 employed in the client 1 receives the eventual usage con dition from the license server 4. Subsequently, at the next step S139, the received eventual usage condition is used as an update of the license's usage condition already stored in the storage unit 28.
FIG. 11 is a flowchart used for explaining the processing carried out by the license server 4 to update a license in conjunction with the processing carried out by the client 1 to request that the license be updated. As shown in the figure, the flowchart begins with a step S151 at which the license server 4 is accessed by the client 1. Then, at the next step S152, the CPU 21 employed in the license server 4 receives a request to update a license from the client 1 along with the license-specifying information trans mitted by the client 1 at the step S135. Subsequently, at the next step S153, the CPU 21 reads out a usage condition for the license to be updated in accordance with the request to update the license, or reads out a condition for updating the license, from the storage unit 28. The CPU21 then transmits the condition to the client 1
In response to the transmitted condition, assume that the user of the client 1 enters an application to purchase the usage condition in processing carried out at the step S137 of the flowchart shown in FIG.10. In this case, at the next step S154, the CPU 21 employed in the license server 4 generates data for the applied usage condition and transmits the data to the client 1. As described above, the client 1 uses the received usage condition as an update of the already cataloged usage condition of the license. As described above, the usage con dition was updated in the processing carried out at the step S139.
In the present invention, keys of devices and keys of licenses are managed on the basis of the principle of a broad cast-encryption system as shown in FIG. 12. The keys are organized into a hierarchical tree structure. Leaves, which are at the bottom hierarchical layer, each correspond to keys of each device. In the typical structure shown in FIG. 12, 16 keys 0 to 15 corresponding to 16 devices or 16 licenses are gener ated
Each key denoted by a circular mark is placed at a node of the tree structure. A root key KR is placed at a root node on the top of the tree structure. At the nodes on the second hierar chical layer, keys K0 and K1 are provided. At the nodes on the third hierarchical layer, keys K00 to K11 are placed. At the nodes on the fourth hierarchical layer, keys K000 to K111 are provided. The leaves at the nodes on the bottom hierarchical layer or device nodes are keys K0000 to K1111.
In the hierarchical tree structure, for example, keys K0010 and K0011 are each a subordinate of key K001. In the same way, keys K000 and K001 are each a subordinate of key K00. By the same token, on the higher hierarchical layers, keys K00 and K01 are each a subordinate of key K0. Likewise, keys K0 and K1 are each a subordinate of the root key KR.
Keys required for using content comprise a leaf at a device node of the bottom hierarchical layer and keys at the nodes on higher hierarchical layers including the root key KR. The leaf and the keys on the higher hierarchical layers including the rootkey KR form a path. For example, keys required for using Content 3 are managed by each key of the path including keys K0011, K001, K00, KO and KR, which form a path starting with the leaf K0011 and ending with the root key KR on the basis of the license corresponding to the leaf ID.
The content-exchanging system provided by the present invention typically adopts the principle shown in FIG. 12 to manage keys of devices and licenses placed at nodes laid out to form an 8+24+32-layer structure shown in FIG. 13. In the structure shown in FIG. 13, there are eight subordinate hier archical layers below the root node. A key at each node of the eight hierarchical layers is associated with a category. Examples of categories are a category of equipment using a semiconductor memory Such as a Memory Stick (trademark) and a category of equipment for receiving digital broadcasts. One of the category nodes is the root node of a system called a T system provided by the present invention for man aging licenses.
To put it in detail, subordinates of the root node of the T system are nodes on 24 hierarchical layers. A key at each of the Subordinate nodes is associated with a license. Thus, it is possible to prescribe 2'' licenses or about 16 mega or about 1.6 million licenses. Further subordinates on the lower side are 32 hierarchical layers, which allow 2 users (or clients 1) or about 4 giga or about 4 billion users (or clients 1) to be prescribed. Keys placed at nodes on the 32 hierarchical layers are each a DNK (Device Node Key).
Keys for a device or keys for a license are placed along a path passing through nodes at the 64 (8+24+32) hierarchical layers. Thus, such a path is associated with a device or a license. More particularly, content keys used for encrypting content are encrypted by keys placed at nodes passed through by a path associated with a license for the content. A key at an upper hierarchical layer is encrypted by using its direct Sub ordinate key on a hierarchical layer directly below and put in an EKB to be described later by referring to FIG. 15. A DNK on the bottom hierarchical layer is not put in the EKB, but included in service data to be granted to the client 1 of the user. The client 1 uses a DNK included in the license to decrypt a key, which is placed on a hierarchical layer directly  above the
 DNK and included in the EKB shown in FIG. 15. The EKB is distributed along with the data of the content. The 5 10 15 25 30 35 40 45 50 55 60 65 client 1 then uses the decrypted key to decrypt a key, which is placed on a hierarchical layer directly above the decrypted key and included in the EKB. This decryption process is carried out repeatedly until the client 1 is capable of obtaining all keys placed at nodes passed through by the path associated with the license.
FIG. 14 is a diagram showing the typical classification of categories each associated with a key of a hierarchical tree structure. As shown in FIG. 14, on the top of the hierarchical tree structure, a root key KR2301 is set. On an intermediate hierarchical layer under the root key KR2301, a node key 2302 is set. On the bottom hierarchical layer, a leaf key 2303 is set. Each device has a leaf key, node keys and the rootkey. The nodes keys owned by the device are provided along a path which is associated with the device and connects the leaf key to the root key.
A predetermined node on an Mth hierarchical layer from the root key is set as a category node 2304. In the example shown in FIG. 13, let M be 8. Each node on the Mth hierar chical layer is used as a node for setting a rootkey for a device pertaining to a specific category. That is to say, a device of a category is associated with a path startingata node on the Mth hierarchical layer, passing through nodes on (M+1)th and lower hierarchical layers, and ending at a leaf on the bottom hierarchical layer.
Assume that, at a node 2305 on the Mth hierarchical layer of the hierarchical tree structure shown in FIG. 14, a category of a Memory Stick (trademark) is set. In this case, linked nodes and leaves below this node 2305 are used as nodes and leaves provided specially for the category including a variety of devices each using the Memory Stick. That is to say, nodes and a leaf under the node 2305 are defined as a set of nodes and a leaf which are related to a device defined in the category of the Memory Stick.
In addition, a node on a hierarchical layer several levels below the Mth hierarchical layer can be set as a subcategory node 2306. In the hierarchical tree structure shown in FIG. 14, a node on a hierarchical layer two levels below the Memory Stick category hierarchical layer, on which the node 2305 is provided, is set as a Subcategory node, that is, a node for a Subcategory included in the category of devices each using a Memory Stick. Furthermore, on a hierarchical layer under the node 2306 for a Subcategory of playback-only equipment, a node 2307 for a telephone with a function to play back music is set. Such a telephone is included in the category of play back-only equipment. Moreover, on a hierarchical layer under the node 2307, a PHS node 2308 and a cellular-phone node 2309 are provided. A PHS and a cellular phone are included in the category of a telephone with a function to play back music.
In addition, categories and Subcategories are provided not only for devices but also for nodes controlled by a manufac turer, content provider and a charging institution indepen dently or any arbitrary units, which can be processing units, control units, presentation service units or the like. These units are each referred to as an entity, which is a generic technical term. Assume that a category node is set as a root node provided specially for a game machine XYZ sold by a game machine manufacturer. In this case, the game machine manufacturer is capable of selling the game machine XYZ by storing node keys and a leaf key, which are provided on hierarchical layers below the root node, in the game machine XYZ. Then, encrypted contents or a variety of keys are dis tributed, or the keys are updated by generating an EKB. The EKB consists of node keys and a leaf key which are provided on hierarchical layers below the root node. In this way, it is possible to distribute data usable only by a device under the root node.
As described above, a node is used as a root node and nodes on hierarchical layers below the root node are each set as a category-related node or a Subcategory-related node. In this way, an institution Such as a manufacturer or content provider, which manages a root node on a category hierarchical layer or a Subcategory hierarchical layer, is capable of generating an EKB (Enabling Key Block) with a key at the root node used as the root key thereof by itself and distributing the EKB to devices pertaining to hierarchical layers below the root node. Thus, it is possible to update the keys of the EKB without no effects at all on devices pertaining to a category node not serving as a subordinate to the root node.
Assume that, in the tree structure shown in FIG. 12, four devices 0, 1, 2 and 3 pertaining to a group share commonkeys K00, K0 and KR as node keys. By using this node-key sharing configuration, a common content key can be provided only to devices 0, 1, 2 and 3. For example, node key K00 itself, which is shared by devices 0, 1, 2 and 3, is set as the common content key. In this way, it is possible to set content key common to devices 0, 1, 2 and 3 without transmitting a new key. As an alternative, a new content key Kcon is encrypted by using the node key K00 to result in an encrypted value EncCK00, Kcon), which is then distributed to devices 0. 1, 2 and 3 by way of a network or by storing the value EncCK00, Kcon) in a storage medium distributed to devices 0. 1, 2 and 3. In this way, only devices 0, 1, 2 and 3 are capable of decrypting the value EncCK00, Kcon) by using the com mon node key K00 shared by devices 0, 1, 2 and 3 to produce the content key Kcon. It should be noted that notation Enc (Ka, Kb) denotes data obtained as a result of encryption of a key Kb by using a key Ka.
In addition, assume that it is discovered at a point time t that keys K0011, K001, K00, K0 and KR owned by device 3 have been analyzed and identified by a hacker. In this case, in order to protect data exchanged thereafter in a system (or a group of devices 0, 1, 2 and 3), device 3 needs to be detached from the system. In addition, node keys K001, K00, K0 and KR need to be updated to respectively new keys K(t)001, K(t)00, K(t)0 and K(t)R to be transmitted to devices 0,1 and 2. It should be noted that notation K(t)aaa is an updated key of generation of time point t and is obtained by updating a key Kaaa.
Processing to distribute an updated key is explained below. For example, keys are updated as follows. In the case of the processing to update keys for devices 0,1 and 2 as described above, a table is supplied to devices 0, 1 and 2 by way of a network or by storing the table in a storage unit and Supplying the storage unit to devices 0,1 and 2. The table is block data called an EKB (Enabling Key Block) shown in FIG. 15A. It should be noted that the EKB (Enabling Key Block) com prises encrypted keys for distributing newly updated keys to devices associated with leaves at the nodes on the bottom hierarchical layer of a tree structure like the one shown in FIG. 12. The EKB (Enabling Key Block) is also called a KRB (Key Renewal Block).
The EKB (Enabling Key Block) shown in FIG. 15A is structured as block data that can be updated only by a device requiring node keys thereof to be updated. The typical EKB shown in FIG. 15A is block data created with the objective of distributing updated node keys of generation of time pointt to devices 0,1 and 2 of the tree structure shown in FIG. 12. As is obvious from FIG. 12, devices 0 and 1 each require K(t)00, K(t)0 and K(t)R as updated node keys. On the other hand, device 2 requires K(t)001, K(t)00, K(t)0 and K(t)R as updated node keys

As shown in FIG. 15A, the EKB includes a plurality of
encrypted keys. An encrypted key of the fifth row of the table from the top shown in FIG. 15A is Enc(K0010, K(t)001), which is an updated node key K(t)001 encrypted by using a leaf key K0010 owned by the device 2. The device 2 is thus 10 15 25 30 35 40 45 50 55 60 65 capable of obtaining the updated node key K(t)001 by decryp tion of the encrypted key Enc(K0010, K(t)001) by using the leafkey K0010 owned by device 2 itself. In addition, by using the updated node key K(t)001 obtained as a result of the decryption, it is possible to decrypt an encrypted key EncCK (t)001, K(t)00) of the fourth row of the table shown in FIG. 15A to result in an updated node key K(t)00.
Thereafter, in Such a sequential decryption process, an encrypted key EncCK(t)00, K(t)0) of the second row of the table shown in FIG. 15A is decrypted to result in the updated node key K(t)0, which is then used for decrypting an encrypted key Enc(K(t)0, K(t)R) of the first row to result in the updated node key K(t)R. On the other hand, a node key K000 is not a key to be updated. Updated node keys required by devices 0 and 1 associated with nodes 0 and 1 respectively are K(t)00, K(t)0 and K(t)R. Devices 0 and 1 associated with nodes 0 and 1 respectively each use device keys K0000 and K0001 to decrypt an encrypted key EncCK000, K(t)00) of the third row of the table shown in FIG. 15A to obtain an updated node key K(t)00. Thereafter, in the sequential decryption process, an encrypted key EncCK(t)00, K(t)0) of the second row of the table shown in FIG. 15A is decrypted to result in the updated node key K(t)0, which is then used for decrypting an encrypted key Enc(K(t)0, K(t)R) of the first row to result in the updated node key K(t)R. In this way, devices 0,1 and 2 are each capable of obtaining the updated node key K(t)R.
It should be noted that indices shown in FIG. 15A are absolute addresses of node keys and leaf keys. The node keys and leaf keys are each used as a decryption key for decrypting an encrypted key on the right side of the figure. When it is not necessary to update a node key K(t)0 on an upper hierarchical layer of the tree structure shown in FIG. 12 and the root key K(t)R, while it is necessary to carry out processing to update only a node key K00, an updated node key K(t)00 can be distributed to devices 0,1 and 2 by using an EKB (Enabling Key Block) shown in FIG. 15B.
The EKB shown in FIG. 15B can be used for distributing typically new content keys common to devices pertaining to a specific group. Assume that devices 0, 1, 2 and 3 pertaining to a group enclosed by a dotted line in FIG. 12 each use a recording medium and require a new common content key K(t)con. In this case, data Enc(K(t)00, K(t)con) is distributed to devices 0, 1, 2 and 3 along with the EKB shown in FIG. 15B. The data EncCK(t)00, K(t)con) is a result of encryption of the newly updated content key K(t)con common to devices 0, 1, 2 and 3. The newly updated content key K(t)con is encrypted by using K(t)00 which is a result of encryption of a node key K00 common to devices 0, 1, 2 and 3. By this, the encrypted data EncCK(t)00, K(t)con) can be distributed so that equipment of other groups such as device 4 cannot decrypt the encrypted data.
That is to say, devices 0, 1 and 2 are each capable of decrypting encrypted data by using the key K(t)00 obtained as a result of EKB processing in order to obtain the content key K(t)con of generation of time point t.
FIG.16 is a diagram showing the typical processing carried out by device 0, which has received the data EncCK(t)00, K(t)con) and the EKB shown in FIG.15B through a recording meddium, to obtain the content key K(t)con of generation of time point t. As described earlier, the data EncCK(t)00, K(t) con) is a result of encryption of the newly updated content key K(t)con common to devices 0, 1, 2 and 3. That is to say, in this typical processing, encrypted message data distributed using the EKB is the content key K(t)con. As shown in FIG. 16, in the same EKB processing as that described above, device 0 generates a node key K(t)00 by using an EKB of generation of time point t and a node key K000 stored in advance in the recording medium by itself. The EKB has been stored in the recording medium. Then, device 0 uses the updated node key K(t)00 obtained as a result of decryption to decrypt the updated content key K(t)con. Device 0 then encrypts it by using a leaf key K0000 owned only by device 0 for later use.
FIG. 17 is a diagram showing a typical format of an EKB (Enabling Key Block). A version 601 is an identifier indicat ing a version of the EKB (Enabling Key Block). It should be noted that the version 601 has the functions of determining the most recent EKB and of indicating the relation with con tents. A depth 602 is the number of hierarchical layers in a hierarchical-tree structure for a device serving as a destina tion of the EKB (Enabling Key Block). A data pointer 603 is a pointer pointing to a position in a data portion 606 of the EKB (Enabling Key Block). A tag pointer 604 is a pointer pointing to the position of a tag 607, and a signature pointer 605 is a pointer pointing to the position of a signature 608. The data portion 606 is typically encrypted updated node keys, that is, encrypted keys obtained as a result of encryption of updated node keys as shown in FIG. 16. The tag 607 is a tag showing the positional relationship between encrypted node keys and encrypted leaf keys. The encrypted node keys and the encrypted leaf keys are included in the data portion 606. A rule of providing a tag is explained by referring to FIG. 18.
FIG. 18 is a diagram showing an example of transmitting an EKB (Enabling Key Block) explained earlier by referring to FIG. 15A. Data in this case is shown in FIG. 18B. The address of a top node included in an encrypted key at that time is referred to as a top-node address. In this example, since an updated root key K(t)R is included, the top-node address is KR. In this case, for example, data EncCK(t)0, K(t)R) of the first row corresponds to a position P0 in a hierarchical tree structure shown in FIG. 18A. Data Enc(K(t)00, K(t)0) of the second row corresponds to a position P00 on the lower left side of the position P0 in the hierarchical tree structure. If there is data on a hierarchical layer below a predetermined position of the hierarchical tree structure, the tag is set at 0. If, on the other hand, there is no data on a hierarchical layer below a predetermined position of the hierarchical tree struc ture, the tag is set at 1. Tags are set in the following format: {Left (L) tag, Right (R) tag explained below. At the position P00 on the lower left side of the position P0 corresponding to the data Enc(K(t)0, K(t)R) of the first row shown in FIG. 18B, there is data. Thus, the L tag is set at 0. At a position on the lower right side of the position P0, on the other hand, there is no data. In this case, the R tag is set at 1. In this way, for each data, tags are set. FIG. 18C is a diagram showing a configu ration including a typical array of pieces of data and an array of tags.
A tag is set to indicate which position in the tree structure the corresponding data EncCKXXX, Kyyy) is located at. The key data EncCKXXX, Kyyy) and so on stored in the data portion 606 is no more than an array of keys, which have been encrypted in a simple way. With the tag described above, however, it is possible to identify the position of an encrypted key, which is stored as data, in the tree structure. Without the tag described above, it is also possible to construct data by using node indices associated with pieces of encrypted data as using node indices associated with pieces of encrypted data as is the case with the configuration explained earlier by refer ring to FIG. 15. An example of the data construction is given as follows:

0: Enc(K(t)0, K(t)R) 00: Enc(K(t)00, K(t)0) 000: EncCK(t)000, K(t)00)

A configuration using Such indices, however, results in  redundant data and the amount of data thus increases. As a result, Such a configuration is not desirable for distribution through a network or for other purposes. By using tags as index data showing the positions of keys, however, the posi tions of keys can be recognized by using only a small amount of data.


The EKB format is further explained by referring back to FIG. 17. The signature 608 is an electronic signature of the institution issuing the EKB (Enabling Key Block). Examples of Such an institution are a key management center (the license server 4), content provider (the content server 3) and a charging institution (the charging server 5). A device receiv ing the EKB confirms that the EKB is a valid EKB issued by an authorized EKB issuer by signature authentication.

It is possible to Summarize processing to utilize content supplied by the content server 3 on the basis of a license issued by the license server 4 as described above into what is shown in FIG. 19.

As shown in the figure, when the content server 3 provides content to the client 1, the license server 4 issues a license to the client 1. The content is EncCKc, Content), which is a notation indicating that the content has been encrypted by content key Kc. The content key Kc is encrypted by using a root key KR to produce EncCKR, Kc). The root key KR is obtained from the EKB and corresponds to the key K, shown in FIG. 5. The content key EncCKR, Kc) and the EKB are then added to the encrypted content. The content key EncCKR, Kc), the EKB and the encrypted content are finally supplied to the client 1.

As shown in FIG. 20, the EKB in the example shown in FIG. 19 typically includes Enc (DNK, KR), which is a nota tion indicating that the root key KR has been encrypted by a DNK. Thus, by using a DNK included in service data, the client 1 is capable of obtaining the root key KR from the EKB. Then, it is possible to obtain the content key KC by decryption of EncCKR, Kc) using the root key KR. Finally, it is possible to obtain the content by decryption of EncCKc, Content) using the content key Kc.

By assigning a DNK to each client 1 in this way, it is also possible to individually revoke a client 1 in accordance with the principles shown in FIGS. 12 and 15. In addition, by including an additional license leaf ID as a part of data in the distribution, service data is associated with a license so that it is possible to avoid an illegal copy operation in the client 1. Furthermore, by distributing a secret key and a certificate for each client as service data, it is possible to create content for which the secret key and the certificate for use by the client 1 are used to prevent the end user from carrying out an illegal operation to copy the content. The use of the secret key and the certificate will be described later by referring to the flow chart shown in FIG. 28.

As described earlier by referring to FIG. 13, in accordance with the present invention, a T system for managing licenses at a category node is associated with a category of devices each used for using contents. Thus, a plurality of DNKS can be owned by the same device. As a result, contents pertaining to different categories can be managed using one device.

FIG. 21 is an explanatory diagram showing the assignment of plural contents to one device. To be more specific, a license for using content 1, to which DNK 1 is assigned, is recorded 20 comprises content ID, a license ID, a URL representing an access target for acquiring a license and a watermark. Subsequently, at the next step S175, by using the secret key in a device D1 on the basis of the T system. By the same token, content 2, to which DNK2 is assigned, can be recorded in the device D1 by transferring content 2 from a CD to a Memory Stick. In this way, the device D1 is capable of simultaneously handling two contents, namely, contents 1 and 2, which are distributed by different systems, namely, the T system and a device management system. This feature cannot be imple mented in a case where only one DNK is assigned to a device. An example of Such a case is a case in which an already assigned DNK is deleted when a new DNK is assigned. In addition, for example, license categories 1 and 2 shown in FIG. 22 are assigned to each triangle of the 32 lower-side hierarchical layers shown in FIG. 13. By such assignment, a category is classified into Subcategories for managing Smaller groups such as genres of the content, levels of the content, retail stores of the content and distribution services of the COntent

In the typical assignment shown in FIG. 22, for instance, license categories 1 and 2 pertain to a jazz genre and a rock genre, respectively. License category 1 is associated with contents 1 and 2, each of which has a license ID of 1 and is distributed to users 1, 2 and 3. License category 2 includes contents 3, 4 and 5, each of which has a license ID of 2 and is distributed to users 1 and 3. As described above, in accordance with the present inven tion, independent key management can be executed for each category. In addition, instead of having a DNK embedded in equip ment and/or media, a DNK can also be downloaded to each equipment and/or each media in catalog processing carried out by the license server 4 so as to implement a system allowing a user to purchase the key.

It is desirable to provide content that can be used in all applications by adopting any technique of using the content after creation of the content without regard to what technique is adopted. For example, it is desirable to provide content that can be used in domains with different content distribution services or different usage conditions. In order to provide Such content, according to the present invention, the license server 4 functioning as an authenticating station distributes secret keys and certificates of disclosed keys for the secret keys to users (clients 1) as described above. Then, the users each use a secret key to create a signature to be put on the content in order to assure the integrity of the content and, thus, to prevent the content from being falsified.

Typical processing of the case described above is explained by referring to the flowchart shown in FIG. 23. To be more specific, the processing is a ripping process carried out by the user to record data played back from a CD in the storage unit 28. As shown in the figure, the flowchart begins with a step S171 at which the CPU 21 employed in the client 1 receives input recorded data played back from a CD from the commu nication unit 29. Then, at the next step S172, the CPU 21 forms a judgment as to whether the recorded data input at the step S171 includes a watermark embedded in the data of the content. The watermark comprises 3-bit CCI (Copy Control Information) and a 1-bit trigger. If a watermark is detected, the flow of the processing goes on to a step S173 at which the CPU21 carries out a process to extract the watermark. If, on the other hand, no watermark is detected, the watermark extracting process is skipped.
Then, at the next step S174, the CPU21 creates data of a header to be recorded for the content. The data of the header comprises content ID, a license ID, a URL representing an access target for acquiring a license and a watermark Subsequently, at the next step S175, by using the secret key comprises content ID, a license ID, a URL representing an access target for acquiring a license and a watermark.

Subsequently, at the next step S175, by using the secret key
of the CPU 21 itself, the CPU 21 creates a digital signature based on the data of the header created in the processing carried out at the step S174. The secret key has been obtained from the license server 4 at the step S67 of the flowchart shown in FIG. 7.

Then, at the next step S176, the CPU 21 controls the encryption and decryption unit 24 to encrypt the content by using content key. The content key has been acquired at the same time as the content (See FIG. 5 or 9). Subsequently, at the next step S177, CPU 21 records the data onto a magneto-optical disk 43 in a file format. Typically, the magneto-optical disk 43 is a mini disc.

It should be noted that, in the case of a mini disk used as the recording medium, the CPU 21 supplies the content to the codec unit 25 at the step S176. The codec unit 25 encodes the content, typically in accordance with the ATRAC3 system. The encoded content is further encrypted by the encryption and decryption unit 24. FIG. 24 is a diagram showing a model of content recorded on the recording medium. A watermark WM extracted from the encrypted content (E(At3)) is recorded in aheader outside the content.


FIG.25 is a diagram showing a more detailed configuration of the file format in which the content is recorded onto the recording medium. As is obvious from the typical configura tion, a header including content ID (CID), a license ID (LID), a URL and a watermark (WM) is recorded. In addition, an EKB, data Enc(KR, Kc), a certificate (Cert), a digital header (Sig(Header)), data EncCKc, Content), metadata and a mark are recorded. The data EncCKr. Kc) is a result of encryption of content key Kc by using a root key KR, whereas the data EncCKc, Content) is a result of encryption of the content by using the content key Kc. The digital header Sig(Header) has been generated on the basis of the header.

The watermark is embedded in the content. As shown in FIGS. 24 and 25, in addition to within the content, the water mark is also placed in the header so that information embed ded in the content as the watermark can be detected fast and with ease. Thus, it is possible to quickly form a judgment as to whether the content can be copied. It should noted that the meta data typically represents a jacket, pictures, a libretto and other information. The mark will be described later by referring to FIG. 31.

FIG. 26 is a diagram showing a typical disclosed-key cer tificate used as the certificate of a disclosed key. Normally, a disclosed-key certificate is a certificate issued by a CA (Cer tificate Authority) in a disclosed-key encryption system. A disclosed-key certificate is issued by the Certificate Authority by adding information Such as a term of validity to a disclosed key and a user ID supplied to the Certificate Authority, as well as by putting a digital signature of the Certificate Authority thereon. In accordance with the present invention, the license server 4 or the content server 3 issues a certificate and a secret key and, thus, also a disclosed key. Therefore, by presenting information Such as a user ID and a password to the license server 4 to be cataloged therein, the user is able to obtain a disclosed-key certificate.

The disclosed-key certificate shown in FIG. 26 includes a message. The message includes a version number of the cer tificate, a serial number issued for the user of the certificate by the license server 4, an algorithm and parameters which are used for a digital signature, the name of the Certificate Authority, the term of validity of the certificate, an ID assigned to the user of the certificate and a disclosed key of the certificate user. In this case, the Certificate Authority is the license server 4. The ID assigned to the user is a node ID or a  leaf ID. A digital signature created by the license server 4 serving as the Certificate Authority is added to the message. The digital signature is data created by using a secret key of the license server 4 on the basis of a hash value generated by application of a hash function to the message.
